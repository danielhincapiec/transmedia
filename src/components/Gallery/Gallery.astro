---
interface Image {
	url: string;
	texto?: string;
	col?: number;
	row?: number;
	order?: number;
}

interface Props {
	images: Image[];
	columns?: number;
}

const { images, columns = 1 } = Astro.props;
---

<div class="mb-8">
	<div class="gallery-grid" style={`--columns: ${columns}`}>
		{
			images.map((image, index) => (
				<div
					class="gallery-item"
					style={`--order: ${image.order ?? 0}; --column: span ${image.col ?? 1} ; --row: span ${image.row ?? 1} ;`}
					data-index={index}
				>
					<img src={image.url} alt={image.texto} loading="lazy" />
					{/* <div class="gallery-overlay">
						<span>{image.texto}</span>
					</div> */}
				</div>
			))
		}
	</div>

	<div class="lightbox" id="lightbox">
		<button class="lightbox-close" aria-label="Cerrar">&times;</button>
		<button class="lightbox-prev" aria-label="Anterior">&#10094;</button>
		<button class="lightbox-next" aria-label="Siguiente">&#10095;</button>

		<div class="lightbox-content">
			<img src="" alt="" id="lightbox-image" />
			<div class="lightbox-caption" id="lightbox-caption"></div>
		</div>

		<div class="lightbox-counter" id="lightbox-counter"></div>
	</div>
</div>

<style>
	.gallery-container {
		/* width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		padding: 20px; */
	}

	.gallery-grid {
		--columns: 4;
		display: grid;
		grid-template-columns: repeat(
			auto-fill,
			minmax(calc(1250px / var(--columns)), 1fr)
		);
		gap: 16px;
		grid-auto-flow: dense;

		@media (width < 1024px) {
			grid-template-columns: 1fr 1fr;
		}
	}

	.gallery-item {
		order: var(--order);
		grid-column: var(--column);
		grid-row: var(--row);
		position: relative;
		overflow: hidden;
		border-radius: 8px;
		cursor: pointer;
		background: #f0f0f0;
		/* aspect-ratio: 1; */

		@media (width < 1024px) {
			grid-column: span 1;
			grid-row: span 1;
		}
	}

	.gallery-item img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.gallery-item:hover img {
		transform: scale(1.1);
	}

	.gallery-overlay {
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
		padding: 20px 10px 10px;
		transform: translateY(100%);
		transition: transform 0.3s ease;
	}

	.gallery-item:hover .gallery-overlay {
		transform: translateY(0);
	}

	.gallery-overlay span {
		color: white;
		font-size: 14px;
		display: block;
	}

	.lightbox {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.95);
		z-index: 9999;
		align-items: center;
		justify-content: center;
	}

	.lightbox.active {
		display: flex;
	}

	.lightbox-content {
		max-width: 100%;
		max-height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		width: 100%;
		height: 100%;
		/* border: 3px solid lime; */
		position: relative;
	}

	#lightbox-image {
		/* border: 3px solid tomato; */
		max-width: none;
		object-fit: contain;
		width: 100%;
		height: 100%;
		border-radius: 4px;
		position: absolute;
		inset: 0;
		z-index: 0;
	}

	.lightbox-caption {
		color: white;
		margin-top: 20px;
		font-size: 18px;
		max-width: 600px;
		position: absolute;
		bottom: 20px;
		left: 0;
		background-color: #000000bd;
		padding: 10px;
		display: inline;
		max-width: 300px;
	}

	.lightbox-close,
	.lightbox-prev,
	.lightbox-next {
		position: absolute;
		z-index: 1;
		background: rgba(255, 255, 255, 0.1);
		border: none;
		color: white;
		font-size: 32px;
		cursor: pointer;
		padding: 10px 15px;
		transition: background 0.3s ease;
		border-radius: 4px;
	}

	.lightbox-close:hover,
	.lightbox-prev:hover,
	.lightbox-next:hover {
		background: rgba(255, 255, 255, 0.2);
	}

	.lightbox-close {
		top: 20px;
		right: 20px;
		font-size: 40px;
		padding: 5px 15px;
	}

	.lightbox-prev {
		left: 20px;
		top: 50%;
		transform: translateY(-50%);
	}

	.lightbox-next {
		right: 20px;
		top: 50%;
		transform: translateY(-50%);
	}

	.lightbox-counter {
		position: absolute;
		top: 20px;
		left: 50%;
		transform: translateX(-50%);
		color: white;
		font-size: 16px;
		background: rgba(0, 0, 0, 0.5);
		padding: 8px 16px;
		border-radius: 20px;
	}

	@media (max-width: 768px) {
		.gallery-grid {
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			gap: 8px;
		}

		.lightbox-prev,
		.lightbox-next {
			font-size: 24px;
			padding: 8px 12px;
		}

		.lightbox-close {
			font-size: 32px;
		}
	}
</style>

<script define:vars={{ images }}>
	let currentIndex = 0;

	const lightbox = document.getElementById("lightbox");
	const lightboxImage = document.getElementById("lightbox-image");
	const lightboxCaption = document.getElementById("lightbox-caption");
	const lightboxCounter = document.getElementById("lightbox-counter");
	const closeBtn = document.querySelector(".lightbox-close");
	const prevBtn = document.querySelector(".lightbox-prev");
	const nextBtn = document.querySelector(".lightbox-next");
	const galleryItems = document.querySelectorAll(".gallery-item");

	function openLightbox(index) {
		currentIndex = index;
		updateLightbox();
		lightbox.classList.add("active");
		document.body.style.overflow = "hidden";
	}

	function closeLightbox() {
		lightbox.classList.remove("active");
		document.body.style.overflow = "";
	}

	function updateLightbox() {
		const image = images[currentIndex];
		lightboxImage.src = image.url;
		lightboxImage.alt = image.texto;
		lightboxCaption.textContent = image.texto;
		lightboxCounter.textContent = `${currentIndex + 1} / ${images.length}`;
	}

	function showNext() {
		currentIndex = (currentIndex + 1) % images.length;
		updateLightbox();
	}

	function showPrev() {
		currentIndex = (currentIndex - 1 + images.length) % images.length;
		updateLightbox();
	}

	galleryItems.forEach((item, index) => {
		item.addEventListener("click", () => openLightbox(index));
	});

	closeBtn.addEventListener("click", closeLightbox);
	prevBtn.addEventListener("click", showPrev);
	nextBtn.addEventListener("click", showNext);

	lightbox.addEventListener("click", (e) => {
		if (e.target === lightbox) {
			closeLightbox();
		}
	});

	document.addEventListener("keydown", (e) => {
		if (!lightbox.classList.contains("active")) return;

		if (e.key === "Escape") closeLightbox();
		if (e.key === "ArrowRight") showNext();
		if (e.key === "ArrowLeft") showPrev();
	});
</script>
